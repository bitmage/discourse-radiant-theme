<script type="text/discourse-plugin" version="1.24.0">
  const tag_id = 'remove-topics-from-categories'
  const regex_category_page = /\/c\/(\w+)\/\d+/
  const regex_product_page = /\/s\/(\w+)/

  api.onPageChange(() => {
    remove_topics()
    subscribe_selector()
    remove_subscribe_when_not_logged_in()
    add_donate_button()
  })

  // Remove Topics (from Categories Pages)
  // (so only the subcategories will display)
  // *------------------------------------------------*
  function remove_topics() {
    // if the page we're on is on this list of categories
    const target_categories = ['experts', 'initiatives']
    const matches = window.location.pathname.match(regex_category_page)
    if (matches != null && target_categories.includes(matches[1])) {

      // then create a style tag to remove topics from the listing
      const styles = `
        .topic-list-body {display: none !important;}
      `
      const tag = document.createElement('style')
      tag.type = 'text/css'
      tag.id = tag_id
      if (tag.styleSheet) {
        tag.styleSheet.cssText = styles
      }
      else {
        tag.append(document.createTextNode(styles))
      }
      document.head.append(tag)
    } else {

      // otherwise, remove the tag so other pages can see these items
      document.querySelectorAll('#' + tag_id).forEach(el => el.remove())
    }
  }

  // Subscribe Selector
  // (Provide a currency selector to filter subscription plans)
  // *------------------------------------------------*
  // currency should be either £ or $
  const currency_options = ['£', '$']
  function show_subscribe_options(currency) {
    if (!currency_options.includes(currency)) throw new Error(`invalid currency option: ${currency}`)
    Array.from(document.querySelectorAll('.btn-discourse-subscriptions-subscribe')).forEach(el => {
      if (el.querySelector('.amount')?.textContent?.includes(currency)) {
        el.style = ''
      } else {
        el.style = 'display: none;'
      }
    })
  }

  function display_currency_dropdown() {
    // find the plans section
    const plans_section = document.querySelector('.subscribe-buttons').parentElement
    const plans_description = plans_section.querySelector('p')

    // construct a currency dropdown
    const currency_dropdown = document.createElement('select')
    currency_dropdown.id = 'currency-dropdown'
    currency_dropdown.style = 'display: inline-block; margin-left: 1em; width: 4em;'
    currency_options.forEach(o => {
      const el = document.createElement('option')
      el.value = o
      el.text = o
      currency_dropdown.append(el)
    })

    // when the currency dropdown updates, hide/show the appropriate plans
    currency_dropdown.addEventListener('change', e => {
      console.log('currency changed:', e.target.value)
      show_subscribe_options(e.target.value)
    })
    // show_subscribe_options()

    // put the dropdown after the description
    plans_description.style = 'display: inline-block;'
    plans_description.after(currency_dropdown)
  }

  // hacky hacky way of getting additional HTML into the subscription page
  function update_description() {
    const container = document.querySelector('.discourse-subscriptions-confirmation-billing')
    const hr = container.querySelector('hr')

    const first = document.createElement('p')
    first.textContent = 'Our Shows, News, and Articles are here to raise awareness and will always remain free.  In addition you can participate in conversations in many areas of the forum, but may not be able to create new posts.'

    const third = document.createElement('p')
    third.textContent = 'As a non-profit organisation, 100% of your membership funds are applied to our mission: Raising awareness about the rise of Stakeholder Capitalism and promoting discussion and formation of alternatives.  As we develop the platform we will continue to look for ways to enable our community to collect, envision, and build a brighter future.  We thank you for your support, and for joining us on this journey!'

    const salutation = document.createElement('p')
    salutation.textContent = 'Richard and Brandon'

    hr.after(first)
    container.append(third)
    container.append(salutation)
  }

  function subscribe_selector() {
    // if we're on the subscription page
    const target_products = ['prod_QGl85xW80N0SQz']
    const matches = window.location.pathname.match(regex_product_page)
    if (matches != null && target_products.includes(matches[1])) {

      show_subscribe_options('£') // show £ by default
      display_currency_dropdown()
      update_description()
    }
  }

  function remove_subscribe_when_not_logged_in() {
    if (api.getCurrentUser()) return
    document.querySelector('.custom-header-links a[href="/s"]').parentElement.remove()
  }

  function add_donate_button() {
    const footer = document.querySelector('.sidebar-footer-wrapper')
    const button_embed = `<div style="width: 200px">
      <stripe-buy-button
          buy-button-id="buy_btn_1PTVIRIdwyDCjzwhf7PlhZ5X"
          publishable-key="pk_live_51IDs5BIdwyDCjzwhKGrADpwGPeLBRjEr5GGo9bXFn9WE1F9JpreSaLtPyIffsCHbcYxK0iDduNkorgnhuRIfDdQc00ISSdXiYE">
      </stripe-buy-button>
    </div>`

    footer.insertAdjacentHTML('afterbegin', button_embed)
  }
</script>
<script async src="https://js.stripe.com/v3/buy-button.js"></script>
